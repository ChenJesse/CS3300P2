<html>

<head>
    <!-- header code taken from lecture notes -->
    <!-- Load the d3 library. -->
    <link href='https://fonts.googleapis.com/css?family=Archivo+Black|Archivo+Narrow' rel='stylesheet' type='text/css'>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <title>Fiber Optic Cable</title>
    <style>
        /* put a border around the svg element so we can see the coordinate system better. */
        
        body {
            font-family: "Open Sans";
            overflow-x: hidden;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        
        div {
            margin: auto;
            padding: auto;
        }

        
        svg {
            margin: 0;
        }
        
        h2 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 30;
            color: rgb(255, 255, 255);
        }
        
        p {
            font-family: 'Archivo Narrow', sans-serif;
            font-size: 20;
            color: rgb(255, 255, 255);
        }
        
        h3 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2vw;
            color: rgb(0, 0, 0);
        }
        
        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }
        
        .axis text {
            font-family: sans-serif;
            font-size: 6px;
        }
    </style>
</head>

<body>
    <div id="pic" style="
        margin:0px;
        background: white;
        margin-top: -10%;
        width: 100%;
        ">

        <img src="images/fiber.png" width="100%">
    </div>

    <div id="Intro" style="
        background-color: rgb(161, 54, 71);
        background-size: 100%;
        margin-left: 0%;
        margin-right: 0%;
        padding-top: 20px;
        padding-bottom: 30px;
        padding-right: 50px;
        padding-left: 50px;">
        <h2>What is Fiber Optics?</h2>
        <!-- Definition from http://www.webopedia.com/TERM/F/fiber_optics.html -->
        <p>Fiber optic cables use glass (or plastic) threads (fibers) to transmit data. These threads are capable of transmitting
            messages modulated onto light waves. Fiber optics is a particularly popular technology for local-area networks
            and many telephone companies have begun to adopt it in place of traditional telephone lines.</p>
    </div>
    <div id="mapWorld" style="text-align: center float:left;" ></div>
    
    <br>
    <div style="width:100%; text-align:center;">
        <div id="mapAfrica" style="float:left; min-width:50%;">
            <h3>Fiber Optic Cables </h3></div>
        <div id="chart1" style="float:right; min-width:50%;">
            <h3>Internet Penetration </h3></div>
    </div>
  

    <script>
        //skeleton of code from notes in class 021916

        var width = window.innerWidth,
        height = window.innerHeight;

		// A projection is a particular type of scale, that maps
		// a pair of LONGITUDE, LATITUDE coordinates (NOT the other
		// way around) to a point in pixel space.
     
        var projection = d3.geo.mercator()
            .translate([width / 2, (3 * height) / 4.5])
            .scale((width ) / 2 / Math.PI);                
		var projection2 = d3.geo.mercator()
            .translate([(width *1.5) , (3 * height) / 4.5])
            .scale((width ) / 2 / Math.PI); // Line taken from Mike Bostock's Block 3757132 http://www.blocks.org/mbostock/3757132
     							
		var path = d3.geo.path().projection(projection);
        var path2 = d3.geo.path().projection(projection2);


		var svg = d3.select("#mapWorld")
            .append("svg")
                .attr("width",  width)
                .attr("height", height)
                .attr("id","worldmap");
		var g = svg.append("g");
		    svg.append("text")
                .attr("text-anchor", "middle")
                .attr("transform", "translate("+ (width*1/2) +"," + 60 +")")
                .style("font-family", "Archivo Black")
                .style("font-size", height*.03)
                .style("color", "rgb(24, 33, 87)")
                .text("Fiber Optic Cables Throughout the World");
        var g2 = svg.append("g");



        function resetMap(){
            g.transition().duration(800).attr("transform", "translate("+ 0+"," + 0 +")");
            g2.transition().duration(800).attr("transform", "translate("+ 0+"," + 0 +")");
            d3.selectAll("path").style("fill","purple");
        }
        //allow to double click and zoom out
        svg.on("dblclick",function(){ 
           resetMap();
        });
	

		//adding legend for meaning of opacity in worldmap

		var numbColors = 10;
		svg.append("g")
		.append("defs")
		.append("linearGradient")
            .attr("id", "legendGradient")
            .attr("x1", "0%")
            .attr("x2", "100%")
            .attr("y1", "0%")
            .attr("y2", "0%");
		svg.append("rect")
            .attr("width", width/2)
            .attr("height", height/25)
            .attr("stroke", "grey")
			.attr("transform", "translate("+ (width*1/2 - width/4) +"," + (height*.94) +")")
			.style("fill","url(#legendGradient)")
			.attr("rx", 10)
			.attr("ry", 10);

        var opacities = [];
        for (var i = 0; i < numbColors; i++) {
            var opacity = 100/(numbColors-1)*i/100;
            var offset = 1/(numbColors-1) * i;
            opacities.push({"off": offset, "op": opacity});
        }

		var stops = d3.select('#legendGradient').selectAll('stop')
		.data(opacities);

		stops.enter().append('stop');
		stops.attr('offset', function(d) { return d.off; })
		    .attr('stop-color', "purple")
		    .attr('stop-opacity',function(d) { return d.op; });
		
		svg.append("text")
            .attr("class", "legendText")
            .attr("x", (width*1/2 - width/4) - 25)
            .attr("y", (height*.94) + height/40)
            .style("font-family", "Archivo Narrow")
            .text("0%");

		svg.append("text")
            .attr("class", "legendText")
            .attr("x", (width*1/2 - width/4) + width/2 + 5)
            .attr("y", (height*.94) + height/40)
            .style("font-family", "Archivo Narrow")
            .text("100%");
		svg.append("text")
            .attr("class", "legendText")
            .attr("x", width*1/2)
            .attr("text-anchor", "middle")
            .attr("y", (height*.93))
            .style("font-family", "Archivo Narrow")
            .style("font-size",height/65)
            .text("Internet Penetration Per Capita");
		//done with adding world legend

		

		var opacityScale = d3.scale.log().domain([1,2]).range([0.05,1]);

		// var africanCountries =[];
		// var africanCountriesString = "Algeria,Angola,Benin,Botswana,Burkina Faso,Burundi,Cape Verde,Cameroon,Central African Republic,Chad,Comoros,Cote d'Ivoire,Congo,CÃ´te d'Ivoire,Djibouti,Egypt,Equatorial Guinea,Eritrea,Ethiopia,Gabon,Gambia,Ghana,Guinea,Guinea-Bissau,Kenya,Lesotho,Liberia,Libya,Madagascar,Malawi,Mali,Mauritania,Mauritius,Morocco,Mozambique,Namibia,Niger,Nigeria,Rwanda,Sao Tome and Principe,Senegal,Seychelles,Sierra Leone,Somalia,South Africa,South Sudan,Sudan,Swaziland,Togo,Tunisia,Uganda,Western Sahara,Zambia,Zimbabwe";
		// africanCountries = africanCountriesString.split(",");
		// africanCountries.push("Congo, the Democratic Republic of the","Tanzania, United Republic of");
		// var africanInternetUsers = [];

		// Get a JSON file containing coordinates of 
		//  countries and landmasses. This is from an 
		//  example provided by Mike Bostock.
		//d3.json("world-50m.json", function(error, world) {
        d3.json("data/internet-users.json", function(error1, userData) {
            if (error1) { return console.log(error1); }			
            d3.json("data/world-topo-min.json", function(error2, world) {
                // ANY time we do I/O we should check for errors.
                if (error2) { return console.log(error2); }			
                // Get an array of coordinate lists for 241 
                //  geographic entites. This includes sovereign 
                //  countries as well as territories like Guam.
                var countries = topojson.feature(world, world.objects.countries).features;
                
                // convert each country's data into a path element.
                var isMouseDown=false;

                g.selectAll("path")
                 .data(countries)
                 .enter().append("path")
                 .attr("d",path)
                 .style("fill", "purple")
                 .style("stroke", "#888")
                 .style("fill-opacity",  function(d){return calcOpacity(d)})
                 .attr("title", function(d){return d.properties.name})
                .attr("id",function(d){return "country"+d.id;})
                 .on("click",function(d){worldMapClicked(d,true)})
                 // .on("mousedown",function(){isMouseDown=true;})
                 // .on("mouseup",function(){isMouseDown=false;})
                 // .on("mousemove",function() {if(isMouseDown){
                 //  var p = d3.mouse(this);
                 //  projection.rotate([pi(p[0]), 0]);
                 //  svg.selectAll("path").attr("d", path);
                 //  }})
                 //.on("dblclick",function(d){worldMapClicked(d,false)})
                 .on("dblclick",function(d){worldMapClicked(d,false)})
                 ;

                  g2.selectAll("path")
                 .data(countries)
                 .enter().append("path")
                 .attr("d",path2)
                 .style("fill", "purple")
                 .style("stroke", "#888")
                 .style("fill-opacity",  function(d){return calcOpacity(d)})
                 .attr("title", function(d){return d.properties.name;})
                 .attr("id",function(d){return "country"+d.id;})
                 .on("click",function(d){worldMapClicked(d,true)})
                 .on("dblclick",function(d){worldMapClicked(d,false)})
                 ;

                 function calcOpacity(d){
                    var internet_user_data =  userData.find(function(data) {
                    return data.Country == d.properties.name; 
                    });

                    if(internet_user_data == null) {
                        internet_user_data = { "Internet" : 0};
                    }

                    return internet_user_data.Internet;
                 }


                function worldMapClicked(c,isSingleClick){
                    if(isSingleClick){
                    var centroid = path.centroid(c),
                        [x,y] = centroid,
                        [[left, top],[right, bottom]]=path.bounds(c),
                        cHeight = bottom-top,
                        cWidth = right - left,
                         k = 1;
                         x=x;
                    if(cHeight>cWidth){k = (height/cHeight)/1.6;}
                    else {k = width/2/cWidth/2.3;}

                    if(k<0.5){k=1;}
                    else if(k<1.5){k=1.8;}
                    else {k=k;}
                    console.log("width  :"+cWidth + "  height   :"+cHeight +"  K   :"+k)
                    //data anomoly in france
                    if(c.properties.name =="France"){k=7}

                    d3.selectAll("path").style("fill","grey");

                  // g.append("circle").attr("cx",x).attr("cy",y).attr("r",5);
                    var countryPath = d3.selectAll("#country"+c.id)[0][0];
                    countryPath.style.fill = "purple";

                    console.log(d3.selectAll("#country"+c.id))
                    g.transition().duration(800)
                     .attr("transform", "translate(" + width / 4 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                     .style("stroke-width", 1.5 / k + "px");
                    g2.transition().duration(800)
                     .attr("transform", "translate(" + width / 4 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                     .style("stroke-width", 1.5 / k + "px");

                    }
                     else{
                        resetMap();
                        }
                };
            });		            
        });



        d3.json("data/cable_data.json", function(error, cables) {
            var cables_global = cables;

			// ANY time we do I/O we should check for errors.
			if (error) { return console.log(error); }

			cables.forEach(function(cable) {
				var coordinates = cable.coordinates;
				var temp =[];
				var temp2 =[];

				coordinates = coordinates.replace(/<LineString><coordinates>/g,"").replace("</MultiGeometry>",'').replace("<MultiGeometry>",'').split("</coordinates></LineString>");
				coordinates.pop();
                cable.coordinates = coordinates;
                console.log(cable.coordinates)

			});

            // g.selectAll("polyline")
            //      .data(cables)
            //      .enter().append("polyline")
            //      .attr("style","fill:none;stroke:"+"red"+";stroke-width:0.6")
            //      .attr("points",function(d){return d.coordinates;});
                 

            // g2.selectAll("polyline")
            //      .data(cables)
            //      .enter().append("polyline")
            //      .attr("style","fill:none;stroke:"+"red"+";stroke-width:0.6")
            //      .attr("points",function(d){return d.coordinates2});
                 

            function coordToString(coordinates,projection){
                var result =[];
                var lonMin = Math.min(), lonMax = Math.max(), latMin = Math.min(), latMax = Math.max(),cableHeight,cableWidth,min,center,lonArray=[],latArray=[];
                coordinates.forEach(function(path){
                    var pathString="";
                    var pathCords = path.split(" ");


                    pathCords.forEach(function(points){
                        [lon,lat,alt] = points.split(",");
                        //no projection lon lat
                        lonArray.push(lon);latArray.push(lat);
                        [lon,lat] = projection([lon,lat]);
                        if(lon>lonMax){lonMax = lon;}
                        if(lon<lonMin){lonMin = lon;}
                        if(lat>latMax){latMax = lat;}
                        if(lat<latMin){latMin = lat;}
                        pathString += lon+","+lat+" ";
                    });
                    result.push(pathString);
                });


                [lonMinOri,lonMaxOri,latMinOri,latMaxOri]=[d3.min(lonArray),d3.max(lonArray),d3.min(latArray),d3.max(latArray)];

                var dist1=lonMax-lonMin;
                var dist2=projection2([lonMinOri,0])[0]-lonMax;
                if(dist1<dist2){center=[lonMin+dist1/2,latMin+(latMax-latMin)/2]; cableWidth = dist1;}
                else{center=[lonMax+(dist2/7),latMin+(latMax-latMin)/2]; cableWidth = dist2/0.9;}

                cableHeight = height/(latMax-latMin)/1.5;
                cableWidth = width/1.5/cableWidth/2.2;
                min=cableWidth;
                if(cableHeight<cableWidth){min = cableHeight}

                return {"coords": result,"height": cableHeight,"width": cableWidth,"min":min,"center": center};
            }
			//add polylines	
			var color = "black",
			color2 = "black",
			stroke_width,
			opacity = 0;
            cables.forEach(function (cable) {
                if(cable.year<2010) {
                    color = "orange";
                    color2 = "orange";
                    opacity  = 0.8;
                } else {
                    color = "#00B24C";
                    color2 = "#00B24C";
                    opacity = 0.7;
                }
        
                var coordToStringResult = coordToString(cable.coordinates,projection);
                 coordToStringResult.coords.forEach(function(paths){
                    g.append("polyline")
                        .attr("style","fill:none;stroke:"+color+";stroke-width:1.6")
                        .attr("points",paths)
                        .attr("id","cable"+cable.cable_id)
                        .attr("title",cable.id)
                        .on("click",function(){
                            var k = coordToStringResult.min;
                            console.log(coordToStringResult)
                            var[x,y] = coordToStringResult.center;

                            g.transition().duration(800)
                            .attr("transform", "translate(" + width/4 + "," + height / 2 + ") scale(" + k + ")translate(" + + -x + "," + -y + ")");  
                            g2.transition().duration(800)
                            .attr("transform", "translate(" + width/4 + "," + height / 2 + ") scale(" + k + ")translate(" + + -x + "," + -y + ")");
                            d3.selectAll("circle").remove();
                            g.append("circle").attr("cx",x).attr("cy",y).attr("r",10)  ;          
                            d3.selectAll("polyline").attr("style","opacity:0.5;fill:none;stroke:"+"grey"+";stroke-width:1");
                            d3.selectAll("#cable"+cable.cable_id).attr("style","fill:none;stroke:"+color+";stroke-width:6");
                        })
                        .on("mouseover", function() {
                            d3.selectAll("#cable"+cable.cable_id).style("stroke-width", "3");
                        })
                        .on("mouseout", function() {
                            d3.selectAll("#cable"+cable.cable_id).style("stroke-width", "1.6");
                        });
                })
                var coordToStringResult2 = coordToString(cable.coordinates,projection2);
                 coordToStringResult2.coords.forEach(function(paths){
                    g.append("polyline")
                        .attr("style","fill:none;stroke:"+color+";stroke-width:1.6")
                        .attr("points",paths)
                        .attr("id","cable"+cable.cable_id)
                        .on("click",function(){
                            var k = coordToStringResult.min;
                            console.log(coordToStringResult)
                            var[x,y] = coordToStringResult.center;

                            g.transition().duration(800)
                            .attr("transform", "translate(" + width/4 + "," + height / 2 + ") scale(" + k + ")translate(" + + -x + "," + -y + ")");  
                            g2.transition().duration(800)
                            .attr("transform", "translate(" + width/4 + "," + height / 2 + ") scale(" + k + ")translate(" + + -x + "," + -y + ")");
                            d3.selectAll("circle").remove();
                            g.append("circle").attr("cx",x).attr("cy",y).attr("r",10)  ;          

                            d3.selectAll("polyline").attr("style","opacity:0.5;fill:none;stroke:"+"grey"+";stroke-width:1");
                            d3.selectAll("#cable"+cable.cable_id).attr("style","fill:none;stroke:"+color+";stroke-width:6");
                        })
                        .on("mouseover", function() {
                            d3.selectAll("#cable"+cable.cable_id).style("stroke-width", "3");
                        })
                        .on("mouseout", function() {
                            d3.selectAll("#cable"+cable.cable_id).style("stroke-width", "1.6");
                        });
                })
              
            });
		});


        svg.append("rect").attr("x",0).attr("y",0).attr("width",width/2).attr("height",height).attr("stroke","black").attr("fill","none")

    </script>
</body>

</html>
